<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Loading...</title>
<!-- Bootstrap CSS from CDN with fallback -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
integrity="sha384-9ndCyUa0zIh1+RfQn35fVvLlKQ1rvVUHRoXnXa1QSu1Rq8NnMgCnU2uhXxEjWbbE" crossorigin="anonymous" 
onerror="fallbackCSS()">
<style>
  /* Fallback CSS if Bootstrap fails to load */
  body { font-family: Arial, sans-serif; background-color: #f8f9fa; margin: 20px; }
  h1 { font-size: 2rem; margin-bottom: 1rem; }
  .card { background-color: #fff; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
  .label { font-weight: bold; }
</style>
<script>
  function fallbackCSS() {
    // Fallback CSS in case Bootstrap fails to load
    document.querySelector('style').textContent = `
      body { font-family: Arial, sans-serif; background-color: #f8f9fa; margin: 20px; }
      h1 { font-size: 2rem; margin-bottom: 1rem; }
      .card { background-color: #fff; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
      .label { font-weight: bold; }
    `;
  }

  // Wait for DOM to load
  document.addEventListener('DOMContentLoaded', () => {
    const defaultCIK = '0000813672';
    const urlParams = new URLSearchParams(window.location.search);
    let CIK = urlParams.get('CIK') || defaultCIK;
    CIK = CIK.trim();

    // To handle invalid CIKs (non-digit or wrong length), optional validation
    if (!/^\d{10}$/.test(CIK)) {
      CIK = defaultCIK;
    }

    const endpointBase = 'https://data.sec.gov/api/xbrl/companyconcept/';

    // Function to fetch and update data
    async function fetchData(cik) {
      const url = endpointBase + 'CIK' + cik + '/dei/EntityCommonStockSharesOutstanding.json';
      try {
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'MyApp/1.0 (contact@mydomain.com)', // replace with real contact info
            'Accept': 'application/json'
          }
        });
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        // Save data.json locally (for demo, in real environment, would send to server or save)
        // For simulation, just keep in memory
        window.currentData = data;
        processData(data);
      } catch (error) {
        console.error('Fetch error:', error);
        // Fallback: attempt to load local data.json if exists
        // For demo, we skip fallback
        alert('Failed to fetch data for CIK ' + cik);
      }
    }

    function processData(data) {
      const entityName = data.entityName || 'Unknown Entity';

      // Filter shares for fy > '2020' and numeric val
      const shares = (data.units && data.units.shares) ? data.units.shares : [];
      const filteredShares = shares.filter(s => {
        if (s.fy && s.val) {
          const fyNum = parseFloat(s.fy);
          return fyNum > 2020 && !isNaN(s.val);
        }
        return false;
      });

      if (filteredShares.length === 0) {
        alert('No data found for fiscal years > 2020');
        return;
      }

      // Find max and min by val, tie-breaking arbitrarily
      const maxShare = filteredShares.reduce((prev, curr) => {
        if (curr.val > prev.val) return curr;
        if (curr.val === prev.val && curr.fy > prev.fy) return curr;
        return prev;
      }, filteredShares[0]);

      const minShare = filteredShares.reduce((prev, curr) => {
        if (curr.val < prev.val) return curr;
        if (curr.val === prev.val && curr.fy > prev.fy) return curr;
        return prev;
      }, filteredShares[0]);

      // Save structure
      const saveObject = {
        entityName: entityName,
        max: { val: maxShare.val, fy: maxShare.fy },
        min: { val: minShare.val, fy: minShare.fy }
      };

      // Save to data.json (simulate saving)
      window.savedData = saveObject;
      updatePage(saveObject);
    }

    function updatePage(dataObj) {
      document.title = dataObj.entityName;
      document.getElementById('share-entity-name').textContent = dataObj.entityName;
      document.getElementById('share-max-value').textContent = dataObj.max.val;
      document.getElementById('share-max-fy').textContent = dataObj.max.fy;
      document.getElementById('share-min-value').textContent = dataObj.min.val;
      document.getElementById('share-min-fy').textContent = dataObj.min.fy;
    }

    // Function to load data.json from server or fallback
    async function loadDataJson() {
      // Check if savedData exists (from prior fetch)
      if (window.savedData) {
        updatePage(window.savedData);
        return;
      }

      // Else fetch data.json
      try {
        const response = await fetch('data.json');
        if (response.ok) {
          const json = await response.json();
          // Validate data structure
          if (json.entityName && json.max && json.min) {
            updatePage(json);
          } else {
            throw new Error('Invalid data.json structure');
          }
        } else {
          throw new Error('Failed to fetch data.json');
        }
      } catch (e) {
        // fallback: try to fetch from properly constructed URL based on CIK
        // but for demo, just alert
        console.error('Error loading data.json:', e);
      }
    }

    // Function to update page based on URL CIK parameter
    function handleQueryChange() {
      const params = new URLSearchParams(window.location.search);
      const newCIK = params.get('CIK') || defaultCIK;
      if (newCIK !== CIK) {
        CIK = newCIK.trim();
        if (!/^\d{10}$/.test(CIK)) {
          CIK = defaultCIK;
        }
        fetchData(CIK);
      }
    }

    // Initial fetch
    fetchData(CIK).then(() => {
      // After fetching, attempt to load data.json
      loadDataJson();
    });

    // Listen for URL changes
    window.addEventListener('popstate', handleQueryChange);
  });
</script>
</head>
<body>
<div class="container">
<h1 class="mb-4" id="share-entity-name">Loading...</h1>
<div class="card">
  <div class="card-body">
    <h5 class="card-title">Maximum Shares Outstanding</h5>
    <p class="card-text">
      <span class="label">Value:</span> <span id="share-max-value">-</span><br/>
      <span class="label">Fiscal Year:</span> <span id="share-max-fy">-</span>
    </p>
  </div>
</div>
<div class="card">
  <div class="card-body">
    <h5 class="card-title">Minimum Shares Outstanding</h5>
    <p class="card-text">
      <span class="label">Value:</span> <span id="share-min-value">-</span><br/>
      <span class="label">Fiscal Year:</span> <span id="share-min-fy">-</span>
    </p>
  </div>
</div>
</div>
</body>
</html>